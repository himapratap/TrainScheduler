<!DOCTYPE html>

<html lang="en-us">

<head>

    <meta charset="UTF-8">
    <title>onTime - NJ Transit!</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- LINK TO FIREBASE GOES HERE -->
    <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>

</head>

<body>

    <div class="container">

        <br>

        <!-- Jumbotron -->
        <div class="well">
            <h1 class="text-center">NJ Transit!</h1>

        </div>

        <div class="panel panel-default panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Current Train Schedule</h3>
            </div>
            <div class="panel-body" id="schedule">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Train Name</th>
                            <th>Destination</th>
                            <th>Frequency (min)</th>
                            <th>Next Arrival</th>
                            <th>Minutes Away</th>

                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Most Recent Member Panel -->

        <!-- Sign-Up Panel-->
        <div class="panel panel-default  panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Add Train</h3>
            </div>
            <div class="panel-body">

                <!-- Sign-up Form (note the various input "types")-->

                <form role="form">
                    <div class="form-group">
                        <label for="name-input">Train Name:</label>
                        <input class="form-control" id="train" type="text">
                    </div>
                    <div class="form-group">
                        <label for="destination-input">Destination:</label>
                        <input class="form-control" id="destination" type="text">
                    </div>
                    <div class="form-group">
                        <label for="age-input">First Train Time (HH:mm - military time)</label>
                        <input class="form-control" id="firstTrain" type="time">
                    </div>
                    <div class="form-group">
                        <label for="comment-input">Frequency(min)</label>
                        <input class="form-control" id="frequency" type="number">
                    </div>
                    <button class="btn btn-primary" id="add-train" type="submit">Submit</button>
                </form>

            </div>

        </div>


        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery.js"></script>
        <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>

        <!-- Script -->
        <script src="https://www.gstatic.com/firebasejs/3.7.3/firebase.js">
        </script>
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyDyLPvXg60_MhLW06IFu1U539AiGb8cBQQ",
                authDomain: "njtransit-2a6dc.firebaseapp.com",
                databaseURL: "https://njtransit-2a6dc.firebaseio.com",
                storageBucket: "njtransit-2a6dc.appspot.com",
                messagingSenderId: "534690454205"
            };
            firebase.initializeApp(config);
            var database = firebase.database();
            var train = {
                name: "",
                destination: "",
                firstTrain: "",
                frequency: 0
            }

            $("#add-train").click(function(event) {
                event.preventDefault();
                console.log("Adding train..");
                train.name = $("#train").val();
                train.destination = $("#destination").val();
                train.firstTrain = $("#firstTrain").val();
                train.frequency = $("#frequency").val();
                database.ref().push(train);
                console.log("Added the train to db.Details :-");
                console.log(train);

            });

            // show train details on current schedule
            database.ref().on("child_added", function(childSnapshot) {
                console.log("Retrieving from db");
                console.log(childSnapshot.val());
                // add a row with train details
                train = childSnapshot.val();
                addNewRow(train);
            });


            function addNewRow(train) {
                console.log("Creating new row.. ");
                var row = $("<tr>");
                row.append("<td>" + train.name + "</td>");
                row.append("<td>" + train.destination + "</td>");
                var frequency = train.frequency;

                row.append("<td>" + frequency + "</td>");
                // find next arrival
                console.log("a" + train.firstTrain);
                var firstTrain = moment(train.firstTrain, "hh:mm");
                var currentTime = moment().format("LT");
                var diff = moment().diff(firstTrain,"minutes");
                console.log(' diff', diff);

                var duration = moment.duration(moment().diff(moment(train.firstTrain)));
                var mins = Math.round(Math.abs(duration.asMinutes()));
                var nextTrainTime = parseInt(mins/frequency);
                console.log('minute diff', mins);

                console.log("next train " + nextTrainTime);

                 console.log('currentTime');
                console.log(currentTime);
                console.log("firstTrain");
                console.log(firstTrain);
                // console.log(moment().diff(firstTrain,"H"));
                $("tbody").append(row);
            }

            // Create a variable to reference the database. var database = firebase.database(); // Initial Values var name = ""; var email = ""; var age = 0; var comment = ""; // Capture Button Click $("#add-user").on("click", function(event) { event.preventDefault();
            // Grabbed values from text-boxes name = $("#name-input").val().trim(); email = $("#email-input").val().trim(); age = $("#age-input").val().trim(); comment = $("#comment-input").val().trim(); // Code for "Setting values in the database" database.ref().set({
            // name: name, email: email, age: age, comment: comment }); }); // Firebase watcher + initial loader HINT: .on("value") database.ref().on("value", function(snapshot) { // Log everything that's coming out of snapshot console.log(snapshot.val()); console.log(snapshot.val().name);
            // console.log(snapshot.val().email); console.log(snapshot.val().age); console.log(snapshot.val().comment); // Change the HTML to reflect $("#name-display").html(snapshot.val().name); $("#email-display").html(snapshot.val().email); $("#age-display").html(snapshot.val().age);
            // $("#comment-display").html(snapshot.val().comment); // Handle the errors }, function(errorObject) { console.log("Errors handled: " + errorObject.code); });
        </script>

</body>

</html>
